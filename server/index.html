<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Web MQTT con HiveMQ</title>
</head>
<body>
    <h1>Aplicación Web MQTT con HiveMQ</h1>

    <!-- Campos para configurar los datos de conexión -->
    <h3>Datos de Conexión MQTT</h3>
    <label for="brokerUrl">URL del Broker:</label>
    <input type="text" id="brokerUrl" value="wss://mycluster123.mqtt.hivemq.cloud:8000" placeholder="Ejemplo: wss://mycluster123.mqtt.hivemq.cloud:8000">
    <br><br>

    <label for="clientId">Client ID:</label>
    <input type="text" id="clientId" value="your-client-id" placeholder="Ejemplo: client-1">
    <br><br>

    <label for="username">Username:</label>
    <input type="text" id="username" value="public" placeholder="Ejemplo: public">
    <br><br>

    <label for="password">Password:</label>
    <input type="password" id="password" value="your-password" placeholder="Ejemplo: 12345">
    <br><br>

    <!-- Campos para los tópicos y mensajes -->
    <label for="publishTopic">Tópico de Publicación:</label>
    <input type="text" id="publishTopic" value="test/topic" placeholder="Ejemplo: test/topic">
    <br><br>

    <label for="subscribeTopic">Tópico de Suscripción:</label>
    <input type="text" id="subscribeTopic" value="test/topic" placeholder="Ejemplo: test/topic">
    <br><br>

    <label for="message">Mensaje:</label>
    <textarea id="message" placeholder="Escribe tu mensaje"></textarea>
    <br><br>

    <button id="sendBtn">Enviar</button>

    <h3>Mensajes Recibidos:</h3>
    <div id="receivedMessages"></div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        // Función para obtener los datos de conexión desde los campos de la interfaz
        function getConnectionData() {
            return {
                brokerUrl: document.getElementById('brokerUrl').value,
                clientId: document.getElementById('clientId').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
        }

        // Conectar al broker MQTT
        function connectToBroker() {
            const { brokerUrl, clientId, username, password } = getConnectionData();

            // Conectar al broker de HiveMQ
            const client = mqtt.connect(brokerUrl, {
                clientId: clientId,
                username: username,
                password: password
            });

            client.on('connect', function () {
                console.log('Conectado al broker de HiveMQ');

                // Suscribirse al tópico de suscripción
                const subscribeTopic = document.getElementById('subscribeTopic').value || 'test/topic';
                client.subscribe(subscribeTopic, function (err) {
                    if (!err) {
                        console.log('Suscrito al tópico: ' + subscribeTopic);
                    }
                });
            });

            // Enviar mensajes al broker
            document.getElementById('sendBtn').onclick = function () {
                const message = document.getElementById('message').value;
                const publishTopic = document.getElementById('publishTopic').value || 'test/topic'; // Tópico por defecto si no se ingresa uno

                if (message && publishTopic) {
                    client.publish(publishTopic, message); // Publicar en el tópico
                    console.log(`Mensaje enviado al tópico ${publishTopic}: ${message}`);
                }
            };

            // Recibir mensajes del tópico suscrito
            client.on('message', function (topic, message) {
                console.log(`Nuevo mensaje en el tópico ${topic}: ${message.toString()}`);
                const receivedMessages = document.getElementById('receivedMessages');
                const newMessage = document.createElement('div');
                newMessage.textContent = `Tópico: ${topic} - Mensaje: ${message.toString()}`;
                receivedMessages.appendChild(newMessage);
            });
        }

        // Llamar a la función de conexión cuando la página cargue
        window.onload = function () {
            connectToBroker();
        };

        // Actualizar la conexión si los datos de conexión cambian
        document.getElementById('brokerUrl').addEventListener('input', function () {
            connectToBroker();
        });
        document.getElementById('clientId').addEventListener('input', function () {
            connectToBroker();
        });
        document.getElementById('username').addEventListener('input', function () {
            connectToBroker();
        });
        document.getElementById('password').addEventListener('input', function () {
            connectToBroker();
        });
    </script>
</body>
</html>
