<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="MQTT WebSocket Client">
    <title>MQTT WebSocket Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/4.2.3/css/foundation.min.css">
</head>
<body class="notconnected">
    <div id="header">
        <h1>MQTT WebSocket Client</h1>
    </div>

    <!-- Formulario de conexión -->
    <div id="connection">
        <label>Host</label>
        <input id="urlInput" type="text" value="broker.mqttdashboard.com" />

        <label>Port</label>
        <input id="portInput" type="text" value="8000" />

        <label>Client ID</label>
        <input id="clientIdInput" type="text" value="clientId-1" />

        <button id="connectButton" onclick="connect()">Connect</button>
        <button id="disconnectButton" onclick="disconnect()" disabled>Disconnect</button>
    </div>

    <!-- Formulario para publicar mensajes -->
    <div id="publish">
        <label>Topic</label>
        <input id="publishTopic" type="text" value="test/topic" />

        <label>Message</label>
        <textarea id="publishMessage"></textarea>

        <button onclick="publish()">Publish</button>
    </div>

    <!-- Mensajes recibidos -->
    <div id="messages">
        <h3>Received Messages</h3>
        <ul id="messageList"></ul>
    </div>

    <script src="https://raw.githubusercontent.com/hivemq/hivemq-mqtt-web-client/refs/heads/master/js/mqttws31.js"></script>
    <script>
        var client;

        // Función para conectarse al broker MQTT
        function connect() {
            var host = document.getElementById('urlInput').value;
            var port = parseInt(document.getElementById('portInput').value, 10);
            var clientId = document.getElementById('clientIdInput').value;

            // Crear cliente MQTT usando WebSockets
            client = new Paho.MQTT.Client(host, port, clientId);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            // Opciones de conexión
            var options = {
                onSuccess: onConnect,
                onFailure: onFail
            };

            // Conectar al broker
            client.connect(options);

            // Deshabilitar botón de conectar y habilitar botón de desconectar
            document.getElementById('connectButton').disabled = true;
            document.getElementById('disconnectButton').disabled = false;
        }

        // Función cuando la conexión es exitosa
        function onConnect() {
            console.log("Connected successfully!");

            // Ocultar formulario de conexión y mostrar formulario de publicación
            document.getElementById('connection').style.display = 'none';
            document.getElementById('publish').style.display = 'block';

            // Suscribirse a un tópico para recibir mensajes
            client.subscribe("test/topic", { qos: 0 });
        }

        // Función cuando la conexión falla
        function onFail(message) {
            console.log("Connection failed: " + message.errorMessage);
            alert("Error: " + message.errorMessage);
            document.getElementById('connectButton').disabled = false;
        }

        // Función cuando se pierde la conexión
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
            }
            document.getElementById('connection').style.display = 'block';
            document.getElementById('publish').style.display = 'none';
            document.getElementById('disconnectButton').disabled = true;
            document.getElementById('connectButton').disabled = false;
        }

        // Función cuando llega un mensaje
        function onMessageArrived(message) {
            console.log("Message arrived: " + message.payloadString);
            var messageList = document.getElementById('messageList');
            var li = document.createElement('li');
            li.textContent = "Topic: " + message.destinationName + ", Message: " + message.payloadString;
            messageList.appendChild(li);
        }

        // Función para desconectar
        function disconnect() {
            client.disconnect();
            document.getElementById('disconnectButton').disabled = true;
            document.getElementById('connectButton').disabled = false;
        }

        // Función para publicar un mensaje
        function publish() {
            var topic = document.getElementById('publishTopic').value;
            var message = document.getElementById('publishMessage').value;
            var mqttMessage = new Paho.MQTT.Message(message);
            mqttMessage.destinationName = topic;
            client.send(mqttMessage);
            console.log("Message published: " + message);
        }
    </script>
</body>
</html>
