<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT WebSocket Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/4.2.3/css/foundation.min.css">
</head>
<body class="notconnected">
    <div id="header">
        <h1>MQTT WebSocket Client</h1>
    </div>

    <div id="connection" class="row">
        <div class="large-4 columns">
            <label>Host</label>
            <input id="urlInput" type="text" value="broker.mqttdashboard.com">
        </div>
        <div class="large-2 columns">
            <label>Port</label>
            <input id="portInput" type="text" value="8000">
        </div>
        <div class="large-4 columns">
            <label>ClientID</label>
            <input id="clientIdInput" type="text" value="clientId-1">
        </div>
        <div class="large-2 columns">
            <button id="connectButton" class="button" onclick="websocketclient.connect()">Connect</button>
            <button id="disconnectButton" class="button" onclick="websocketclient.disconnect()" disabled>Disconnect</button>
        </div>
    </div>

    <div id="publish" class="row" style="display: none;">
        <div class="large-4 columns">
            <label>Topic</label>
            <input id="publishTopic" type="text" value="test/topic">
        </div>
        <div class="large-4 columns">
            <label>Message</label>
            <textarea id="publishMessage"></textarea>
        </div>
        <div class="large-2 columns">
            <button class="button" onclick="websocketclient.publish()">Publish</button>
        </div>
    </div>

    <div id="messages" class="row" style="display: none;">
        <h3>Messages</h3>
        <ul id="messageList"></ul>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqttws31/1.0.1/mqttws31.min.js"></script>
    <script>
        var websocketclient = {
            client: null,
            subscriptions: [],
            messages: [],
            connected: false,

            connect: function() {
                var host = document.getElementById('urlInput').value;
                var port = parseInt(document.getElementById('portInput').value, 10);
                var clientId = document.getElementById('clientIdInput').value;

                // Crear cliente MQTT utilizando WebSocket
                this.client = new Paho.MQTT.Client(host, port, clientId);
                this.client.onConnectionLost = this.onConnectionLost;
                this.client.onMessageArrived = this.onMessageArrived;

                var options = {
                    onSuccess: this.onConnect,
                    onFailure: this.onFail
                };

                // Conectar al broker
                this.client.connect(options);

                // Cambiar estado de los botones
                document.getElementById('connectButton').disabled = true;
                document.getElementById('disconnectButton').disabled = false;
            },

            onConnect: function() {
                websocketclient.connected = true;
                console.log("Connected to the broker!");

                // Mostrar formulario de publicación y mensajes
                document.getElementById('connection').style.display = 'none';
                document.getElementById('publish').style.display = 'block';
                document.getElementById('messages').style.display = 'block';

                // Suscribirse a un tópico (ejemplo)
                websocketclient.subscribe("test/topic");
            },

            onFail: function(message) {
                console.log("Connection failed: " + message.errorMessage);
                alert("Connection failed: " + message.errorMessage);
            },

            onConnectionLost: function(responseObject) {
                websocketclient.connected = false;
                console.log("Connection lost: " + responseObject.errorMessage);
                alert("Connection lost: " + responseObject.errorMessage);
                document.getElementById('connection').style.display = 'block';
                document.getElementById('publish').style.display = 'none';
                document.getElementById('messages').style.display = 'none';

                // Habilitar botón de conectar y deshabilitar botón de desconectar
                document.getElementById('connectButton').disabled = false;
                document.getElementById('disconnectButton').disabled = true;
            },

            onMessageArrived: function(message) {
                var messageObj = {
                    topic: message.destinationName,
                    payload: message.payloadString,
                    timestamp: new Date().toLocaleString()
                };

                websocketclient.messages.push(messageObj);
                websocketclient.renderMessages();
            },

            disconnect: function() {
                if (this.client) {
                    this.client.disconnect();
                }
                this.connected = false;
                console.log("Disconnected from the broker");

                document.getElementById('connectButton').disabled = false;
                document.getElementById('disconnectButton').disabled = true;
            },

            publish: function() {
                var topic = document.getElementById('publishTopic').value;
                var payload = document.getElementById('publishMessage').value;
                var message = new Paho.MQTT.Message(payload);
                message.destinationName = topic;

                this.client.send(message);
                console.log("Message sent: " + payload);
            },

            subscribe: function(topic) {
                if (this.connected) {
                    this.client.subscribe(topic, { qos: 0 });
                    console.log("Subscribed to topic: " + topic);
                }
            },

            renderMessages: function() {
                var messageList = document.getElementById('messageList');
                messageList.innerHTML = '';  // Limpiar lista de mensajes

                websocketclient.messages.forEach(function(message) {
                    var li = document.createElement('li');
                    li.textContent = "Topic: " + message.topic + " | " + message.payload + " | " + message.timestamp;
                    messageList.appendChild(li);
                });
            }
        };

        // Inicializar el cliente cuando se cargue la página
        document.addEventListener('DOMContentLoaded', function() {
            websocketclient.connected = false;
            document.getElementById('disconnectButton').disabled = true;
        });
    </script>
</body>
</html>
