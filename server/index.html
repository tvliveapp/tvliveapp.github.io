<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Web MQTT con SSL</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Asegúrate de tener jQuery -->
</head>
<body>
    <h1>Aplicación Web MQTT</h1>

    <!-- Campos para configurar los datos de conexión -->
    <h3>Datos de Conexión MQTT</h3>
    <label for="brokerUrl">URL del Broker:</label>
    <input type="text" id="brokerUrl" value="broker.mqttdashboard.com" placeholder="Ejemplo: broker.mqttdashboard.com">
    <br><br>

    <label for="port">Puerto:</label>
    <input type="number" id="port" value="8884" placeholder="Ejemplo: 8884">
    <br><br>

    <!-- Checkbox para activar SSL -->
    <label for="sslInput">Usar SSL:</label>
    <input type="checkbox" id="sslInput"> Activar SSL
    <br><br>

    <label for="clientId">Client ID:</label>
    <input type="text" id="clientId" value="your-client-id" placeholder="Ejemplo: client-1">
    <br><br>

    <!-- Los campos de Usuario y Contraseña se dejan vacíos ya que no se requieren -->
    <label for="username">Username:</label>
    <input type="text" id="username" value="" placeholder="Deja vacío si no se requiere">
    <br><br>

    <label for="password">Password:</label>
    <input type="password" id="password" value="" placeholder="Deja vacío si no se requiere">
    <br><br>

    <!-- Campos para los tópicos y mensajes -->
    <label for="publishTopic">Tópico de Publicación:</label>
    <input type="text" id="publishTopic" value="test/topic" placeholder="Ejemplo: test/topic">
    <br><br>

    <label for="subscribeTopic">Tópico de Suscripción:</label>
    <input type="text" id="subscribeTopic" value="test/topic" placeholder="Ejemplo: test/topic">
    <br><br>

    <label for="message">Mensaje:</label>
    <textarea id="message" placeholder="Escribe tu mensaje"></textarea>
    <br><br>

    <button id="sendBtn" disabled>Enviar</button> <!-- Botón de enviar (deshabilitado inicialmente) -->
    <button id="connectBtn">Conectar</button> <!-- Botón de conectar -->
    
    <h3>Mensajes Recibidos:</h3>
    <div id="receivedMessages"></div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        let client;

        // Función para obtener los datos de conexión desde los campos de la interfaz
        function getConnectionData() {
            const ssl = $('#sslInput').is(':checked'); // Verifica si el checkbox está marcado
            const protocol = ssl ? 'wss' : 'ws'; // Si SSL está activado, usa wss (WebSocket seguro)
            const brokerUrl = $('#brokerUrl').val();
            const port = $('#port').val();
            const clientId = $('#clientId').val();
            const username = $('#username').val();
            const password = $('#password').val();
            return {
                brokerUrl: `${protocol}://${brokerUrl}:${port}`, // Crear la URL con el protocolo correcto
                clientId: clientId,
                username: username,
                password: password
            };
        }

        // Función para conectar al broker MQTT
        function connectToBroker() {
            const { brokerUrl, clientId, username, password } = getConnectionData();

            // Conectar al broker
            client = mqtt.connect(brokerUrl, {
                clientId: clientId,
                username: username,
                password: password
            });

            client.on('connect', function () {
                console.log('Conectado al broker');
                document.getElementById('sendBtn').disabled = false; // Habilitar el botón de "Enviar" después de conectar

                // Suscribirse al tópico de suscripción
                const subscribeTopic = document.getElementById('subscribeTopic').value || 'test/topic';
                client.subscribe(subscribeTopic, function (err) {
                    if (!err) {
                        console.log('Suscrito al tópico: ' + subscribeTopic);
                    }
                });
            });

            client.on('error', function (err) {
                console.error('Error de conexión:', err);
                alert('Error de conexión: ' + err.message);
            });

            // Recibir mensajes del tópico suscrito
            client.on('message', function (topic, message) {
                console.log(`Nuevo mensaje en el tópico ${topic}: ${message.toString()}`);
                const receivedMessages = document.getElementById('receivedMessages');
                const newMessage = document.createElement('div');
                newMessage.textContent = `Tópico: ${topic} - Mensaje: ${message.toString()}`;
                receivedMessages.appendChild(newMessage);
            });
        }

        // Enviar mensajes al broker
        document.getElementById('sendBtn').onclick = function () {
            const message = document.getElementById('message').value;
            const publishTopic = document.getElementById('publishTopic').value || 'test/topic'; // Tópico por defecto si no se ingresa uno

            if (message && publishTopic && client) {
                client.publish(publishTopic, message); // Publicar en el tópico
                console.log(`Mensaje enviado al tópico ${publishTopic}: ${message}`);
            }
        };

        // Conectar al broker cuando el usuario haga clic en "Conectar"
        document.getElementById('connectBtn').onclick = function () {
            connectToBroker();
            this.disabled = true; // Deshabilitar el botón de "Conectar" después de hacer clic
            alert('Intentando conectar al broker...');
        };
    </script>
</body>
</html>
